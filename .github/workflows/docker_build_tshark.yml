name: Build and push antrea/tshark Docker image

on:
  pull_request:
    branches:
      - main
    paths:
      - 'images/tshark/**'
      - '.github/workflows/docker_build_tshark.yml'
  push:
    branches:
      - main
    paths:
      - 'images/tshark/**'

env:
  REGISTRY_IMAGE: "antrea/tshark"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Check-out code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - name: Get docker tag
      id: get-tag
      run: |
        matches=$(grep -oP 'tshark=(?:[0-9]+:)?\K[0-9]+\.[0-9]+\.[0-9]+' images/tshark/Dockerfile)
        [ "$(echo "${matches}" | wc -l)" -eq 1 ] || { echo "ERROR: expected exactly one tshark version match, got: ${matches}"; exit 1; }
        tshark_version="${matches}"
        short_sha=$(git rev-parse --short HEAD)
        echo "tshark_version=${tshark_version}" >> $GITHUB_OUTPUT
        echo "docker_tag=${tshark_version}-${short_sha}" >> $GITHUB_OUTPUT
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to DockerHub
      if: ${{ github.repository == 'antrea-io/image-utils' && github.event_name != 'pull_request' }}
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: images/tshark
        platforms: linux/amd64,linux/arm64,linux/arm/v7
        push: ${{ github.repository == 'antrea-io/image-utils' && github.event_name != 'pull_request' }}
        tags: ${{ env.REGISTRY_IMAGE }}:${{ steps.get-tag.outputs.docker_tag }},${{ env.REGISTRY_IMAGE }}:${{ steps.get-tag.outputs.tshark_version }},${{ env.REGISTRY_IMAGE }}:latest
        no-cache: true
